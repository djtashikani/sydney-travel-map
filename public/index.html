<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢è¦³å…‰ãƒãƒƒãƒ—</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: #f0f4f8;
            min-height: 100vh;
        }

        /* éƒ½å¸‚åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– */
        .city-tabs {
            display: flex;
            background: #1a1a2e;
        }

        .city-tab {
            flex: 1;
            padding: 15px 20px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .city-tab.sydney {
            background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
            color: white;
            opacity: 0.6;
        }

        .city-tab.sydney.active {
            opacity: 1;
        }

        .city-tab.melbourne {
            background: linear-gradient(135deg, #7b2cbf 0%, #c77dff 100%);
            color: white;
            opacity: 0.6;
        }

        .city-tab.melbourne.active {
            opacity: 1;
        }

        .city-tab:hover {
            opacity: 0.9;
        }

        .header {
            background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: background 0.3s;
        }

        .header.melbourne {
            background: linear-gradient(135deg, #7b2cbf 0%, #c77dff 100%);
        }

        .header h1 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .main-container {
            display: flex;
            height: calc(100vh - 110px);
        }

        .sidebar {
            width: 350px;
            background: white;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .sidebar-section {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .sidebar-section h3 {
            font-size: 1rem;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .location-setting {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .location-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .location-label {
            width: 60px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .location-label.start { color: #22c55e; }
        .location-label.end { color: #ef4444; }

        .location-display {
            flex: 1;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #666;
            min-height: 40px;
            display: flex;
            align-items: center;
        }

        .location-display.has-value {
            color: #333;
            background: #e8f5e9;
        }

        .location-display.has-value.end {
            background: #ffebee;
        }

        .clear-btn {
            background: #f0f0f0;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .clear-btn:hover {
            background: #e0e0e0;
        }

        .route-search-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .route-search-btn.melbourne {
            background: linear-gradient(135deg, #7b2cbf 0%, #c77dff 100%);
        }

        .route-search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,119,182,0.3);
        }

        .route-search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .route-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .route-option {
            padding: 8px 12px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .route-option:hover {
            background: #e0e0e0;
        }

        .route-option.selected {
            background: #e3f2fd;
            border-color: #0077b6;
            color: #0077b6;
        }

        .spot-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 500px;
            overflow-y: auto;
        }

        .spot-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }

        .spot-item:hover {
            background: #e8f4f8;
        }

        .spot-item.dragging {
            opacity: 0.5;
            background: #e3f2fd;
        }

        .spot-item.drag-over {
            border-top: 3px solid #0077b6;
        }

        .drag-handle {
            cursor: grab;
            color: #999;
            font-size: 1.2rem;
            padding: 5px;
            margin-right: 5px;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .spot-item.selected {
            background: #e3f2fd;
            border: 2px solid #0077b6;
        }

        .spot-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #0077b6;
        }

        .spot-icon {
            font-size: 1.2rem;
        }

        .spot-info {
            flex: 1;
        }

        .spot-name {
            font-weight: bold;
            font-size: 0.9rem;
            color: #333;
        }

        .spot-category {
            font-size: 0.75rem;
            color: #666;
        }

        .spot-actions {
            display: flex;
            gap: 5px;
        }

        .spot-action-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .spot-action-btn.start {
            background: #dcfce7;
            color: #22c55e;
        }

        .spot-action-btn.end {
            background: #fee2e2;
            color: #ef4444;
        }

        .spot-action-btn.delete {
            background: #fef3c7;
            color: #d97706;
        }

        .spot-action-btn:hover {
            transform: scale(1.1);
        }

        .custom-spot-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .custom-spot-input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .custom-spot-input:focus {
            outline: none;
            border-color: #0077b6;
        }

        .add-spot-btn {
            padding: 10px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .add-spot-btn:hover {
            background: #16a34a;
        }

        .map-click-mode {
            padding: 10px;
            background: #fef3c7;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #92400e;
            text-align: center;
        }

        .map-container {
            flex: 1;
            position: relative;
            transition: all 0.3s ease;
        }

        .map-container.minimized {
            flex: 0;
            height: 0;
            min-height: 0;
            overflow: hidden;
        }

        .map-toggle-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.85rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .map-toggle-btn:hover {
            background: #f4f4f4;
        }

        .map-restore-bar {
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .map-restore-bar:hover {
            opacity: 0.9;
        }

        .map-restore-bar.visible {
            display: block;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .share-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .share-overlay.visible {
            display: flex;
        }

        .share-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
        }

        .share-container h3 {
            margin-bottom: 20px;
            text-align: center;
        }

        .share-url-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .share-url-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .copy-btn {
            padding: 12px 20px;
            background: #0077b6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .copy-btn:hover {
            background: #005f8a;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .share-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .share-btn.line {
            background: #06c755;
            color: white;
        }

        .share-btn.close {
            background: #f0f0f0;
            color: #333;
            width: 100%;
            justify-content: center;
        }

        .share-btn:hover {
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 50vh;
            }

            .map-container {
                height: 50vh;
            }

            .header h1 {
                font-size: 1.1rem;
            }

            .city-tab {
                font-size: 0.9rem;
                padding: 12px 10px;
            }
        }

        .custom-marker {
            background: none;
            border: none;
        }

        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .marker-pin span {
            transform: rotate(45deg);
            font-size: 14px;
        }

        .saved-spots-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .saved-spot-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .saved-spot-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .saved-spot-actions {
            display: flex;
            gap: 5px;
        }

        .delete-saved-btn {
            background: #fee2e2;
            color: #ef4444;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .delete-saved-btn:hover {
            background: #fecaca;
        }

        .restore-btn {
            background: #dbeafe;
            color: #2563eb;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .restore-btn:hover {
            background: #bfdbfe;
        }

        /* æ¤œç´¢æ©Ÿèƒ½ */
        .search-box {
            display: flex;
            gap: 8px;
        }

        .search-box .custom-spot-input {
            flex: 1;
        }

        .search-btn {
            padding: 10px 15px;
            background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }

        .search-btn:hover {
            opacity: 0.9;
        }

        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f0f9ff;
            border: 2px solid #e0f2fe;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-result-item:hover {
            background: #e0f2fe;
            border-color: #0077b6;
        }

        .search-result-item.selected {
            background: #dbeafe;
            border-color: #0077b6;
        }

        .search-result-icon {
            font-size: 1.2rem;
        }

        .search-result-info {
            flex: 1;
            overflow: hidden;
        }

        .search-result-name {
            font-weight: bold;
            font-size: 0.9rem;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-address {
            font-size: 0.75rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .divider {
            text-align: center;
            color: #999;
            font-size: 0.85rem;
            margin: 15px 0;
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #ddd;
        }

        .divider::before {
            left: 0;
        }

        .divider::after {
            right: 0;
        }

        .selected-location-info {
            padding: 10px;
            background: #f0fdf4;
            border: 2px solid #86efac;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }

        .selected-location-info.visible {
            display: block;
        }

        .selected-location-info .name {
            font-weight: bold;
            color: #166534;
        }

        .selected-location-info .address {
            font-size: 0.8rem;
            color: #666;
            margin-top: 3px;
        }

        .searching-indicator {
            text-align: center;
            padding: 15px;
            color: #666;
        }

        .no-results {
            text-align: center;
            padding: 15px;
            color: #999;
            font-size: 0.9rem;
        }

        .tab-container {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            color: #666;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #0077b6;
            border-bottom: 3px solid #0077b6;
            margin-bottom: -2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .category-filter {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .category-select {
            margin: 10px 0;
        }

        .category-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .category-option {
            padding: 8px 12px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-option:hover {
            background: #e0e0e0;
        }

        .category-option.selected {
            background: #e3f2fd;
            border-color: #0077b6;
            color: #0077b6;
        }

        .category-btn {
            padding: 6px 12px;
            background: #f0f0f0;
            border: none;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-btn.active {
            background: #0077b6;
            color: white;
        }

        .empty-message {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            padding: 20px;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .user-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .user-modal.hidden {
            display: none;
        }

        .user-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .user-modal-content h2 {
            margin-bottom: 10px;
            color: #333;
        }

        .user-modal-content p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .user-id-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 15px;
        }

        .user-id-input:focus {
            outline: none;
            border-color: #0077b6;
        }

        .user-modal-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .user-modal-btn:hover {
            opacity: 0.9;
        }

        .user-modal-btn.secondary {
            background: #f0f0f0;
            color: #333;
        }

        .user-id-hint {
            font-size: 0.8rem;
            color: #999;
        }

        /* åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .sync-status .user-id {
            font-weight: bold;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }

        .sync-indicator.syncing {
            background: #fbbf24;
            animation: pulse 1s infinite;
        }

        .sync-indicator.offline {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <!-- éƒ½å¸‚åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– -->
    <div class="city-tabs">
        <button class="city-tab sydney active" onclick="switchCity('sydney')">
            ğŸ¦˜ ã‚·ãƒ‰ãƒ‹ãƒ¼
        </button>
        <button class="city-tab melbourne" onclick="switchCity('melbourne')">
            ğŸ¨ ãƒ¡ãƒ«ãƒœãƒ«ãƒ³
        </button>
    </div>

    <div class="header" id="header">
        <h1 id="headerTitle">ğŸ¦˜ ã‚·ãƒ‰ãƒ‹ãƒ¼è¦³å…‰ãƒãƒƒãƒ—</h1>
        <div class="header-buttons">
            <div class="sync-status" onclick="showUserModal()" id="syncStatus">
                <span class="sync-indicator" id="syncIndicator"></span>
                <span class="user-id" id="displayUserId">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
            </div>
            <button class="header-btn" onclick="refreshData()" id="refreshBtn" title="æœ€æ–°æƒ…å ±ã«æ›´æ–°">ğŸ”„</button>
            <button class="header-btn" onclick="shareUrl()">ğŸ”— å…±æœ‰</button>
            <button class="header-btn" onclick="clearAllData()">ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="user-modal hidden" id="userModal">
        <div class="user-modal-content">
            <h2>ğŸ”„ ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</h2>
            <p>IDã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã©ã®ç«¯æœ«ã‹ã‚‰ã§ã‚‚<br>åŒã˜ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™</p>
            <input type="text" class="user-id-input" id="userIdInput" placeholder="ä¾‹: tashikani123" maxlength="20">
            <p class="user-id-hint">3æ–‡å­—ä»¥ä¸Šã®è‹±æ•°å­—ãƒ»ãƒã‚¤ãƒ•ãƒ³ãƒ»ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢</p>
            <button class="user-modal-btn" onclick="loginUser()">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ä½œæˆ</button>
            <button class="user-modal-btn secondary" onclick="closeUserModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="user-modal-btn secondary" onclick="logoutUser()" id="logoutBtn" style="display: none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-section">
                <h3>ğŸ“ ç¾åœ¨åœ°ãƒ»ç›®çš„åœ°</h3>
                <div class="location-setting">
                    <div class="location-input-group">
                        <span class="location-label start">å‡ºç™ºåœ°</span>
                        <div class="location-display" id="startDisplay">ã‚¿ãƒƒãƒ—ã§è¨­å®š</div>
                        <button class="clear-btn" onclick="clearLocation('start')">âœ•</button>
                    </div>
                    <div class="location-input-group">
                        <span class="location-label end">ç›®çš„åœ°</span>
                        <div class="location-display" id="endDisplay">ã‚¿ãƒƒãƒ—ã§è¨­å®š</div>
                        <button class="clear-btn" onclick="clearLocation('end')">âœ•</button>
                    </div>
                    <button class="route-search-btn" id="searchRouteBtn" onclick="searchRoute()" disabled>
                        ğŸ” çµŒè·¯ã‚’æ¤œç´¢
                    </button>
                    <div class="route-options">
                        <button class="route-option selected" data-mode="transit" onclick="selectRouteMode(this)">ğŸšƒ å…¬å…±äº¤é€š</button>
                        <button class="route-option" data-mode="walking" onclick="selectRouteMode(this)">ğŸš¶ å¾’æ­©</button>
                        <button class="route-option" data-mode="driving" onclick="selectRouteMode(this)">ğŸš— è»Š</button>
                    </div>
                </div>
            </div>

            <div class="tab-container">
                <button class="tab-btn active" onclick="switchTab('spots')">è¦³å…‰åœ°</button>
                <button class="tab-btn" onclick="switchTab('custom')">ã‚«ã‚¹ã‚¿ãƒ è¿½åŠ </button>
                <button class="tab-btn" onclick="switchTab('saved')">ä¿å­˜æ¸ˆã¿</button>
            </div>

            <div class="sidebar-section tab-content active" id="tab-spots">
                <div class="category-filter">
                    <button class="category-btn active" onclick="filterCategory('all')">ã™ã¹ã¦</button>
                    <button class="category-btn" onclick="filterCategory('landmark')">ğŸ›ï¸ åæ‰€</button>
                    <button class="category-btn" onclick="filterCategory('nature')">ğŸŒ¿ è‡ªç„¶</button>
                    <button class="category-btn" onclick="filterCategory('culture')">ğŸ­ æ–‡åŒ–</button>
                    <button class="category-btn" onclick="filterCategory('food')">ğŸ½ï¸ ã‚°ãƒ«ãƒ¡</button>
                </div>
                <div class="spot-list" id="spotList"></div>
            </div>

            <div class="sidebar-section tab-content" id="tab-custom">
                <div class="custom-spot-form">
                    <div class="search-box">
                        <input type="text" class="custom-spot-input" id="searchInput" placeholder="ğŸ” å ´æ‰€ã‚’æ¤œç´¢ï¼ˆä¾‹: ã‚ªãƒšãƒ©ãƒã‚¦ã‚¹ã€Bondi Beachï¼‰">
                        <button class="search-btn" onclick="searchLocation()">æ¤œç´¢</button>
                    </div>
                    <div class="search-results" id="searchResults"></div>
                    <div class="divider">ã¾ãŸã¯</div>
                    <div class="map-click-mode" id="mapClickMode">
                        ğŸ“ ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä½ç½®ã‚’é¸æŠ
                    </div>
                    <div id="selectedCoords" style="font-size: 0.85rem; color: #666; text-align: center;"></div>
                    <div class="selected-location-info" id="selectedLocationInfo"></div>
                    <input type="text" class="custom-spot-input" id="customSpotName" placeholder="ä¿å­˜ã™ã‚‹åå‰ï¼ˆç©ºæ¬„ã§æ¤œç´¢çµæœã®åå‰ã‚’ä½¿ç”¨ï¼‰">
                    <div class="category-select">
                        <label style="font-size: 0.85rem; color: #666; margin-bottom: 5px; display: block;">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ:</label>
                        <div class="category-options" id="categoryOptions">
                            <button type="button" class="category-option" data-category="landmark" onclick="selectCategory('landmark')">ğŸ›ï¸ åæ‰€</button>
                            <button type="button" class="category-option" data-category="nature" onclick="selectCategory('nature')">ğŸŒ¿ è‡ªç„¶</button>
                            <button type="button" class="category-option" data-category="culture" onclick="selectCategory('culture')">ğŸ­ æ–‡åŒ–</button>
                            <button type="button" class="category-option" data-category="food" onclick="selectCategory('food')">ğŸ½ï¸ ã‚°ãƒ«ãƒ¡</button>
                        </div>
                    </div>
                    <button class="add-spot-btn" onclick="addCustomSpot()">â• ã“ã®åœ°ç‚¹ã‚’è¿½åŠ </button>
                </div>
            </div>

            <div class="sidebar-section tab-content" id="tab-saved">
                <h4 style="font-size: 0.9rem; color: #333; margin-bottom: 10px;">ğŸ“Œ ã‚«ã‚¹ã‚¿ãƒ è¿½åŠ ã—ãŸåœ°ç‚¹</h4>
                <div class="saved-spots-list" id="savedSpotsList"></div>
                <h4 style="font-size: 0.9rem; color: #666; margin: 15px 0 10px 0;">ğŸ—‘ï¸ å‰Šé™¤ã—ãŸè¦³å…‰åœ°ï¼ˆã‚¿ãƒƒãƒ—ã§å¾©å…ƒï¼‰</h4>
                <div class="saved-spots-list" id="hiddenSpotsList"></div>
            </div>
        </div>

        <div class="map-restore-bar" id="mapRestoreBar" onclick="toggleMap()">
            ğŸ—ºï¸ åœ°å›³ã‚’è¡¨ç¤ºã™ã‚‹
        </div>
        <div class="map-container" id="mapContainer">
            <button class="map-toggle-btn" id="mapToggleBtn" onclick="toggleMap()">
                â– åœ°å›³ã‚’æœ€å°åŒ–
            </button>
            <div id="map"></div>
        </div>
    </div>

    <div class="share-overlay" id="shareOverlay">
        <div class="share-container">
            <h3>ğŸ”— ãƒãƒƒãƒ—ã‚’å…±æœ‰</h3>
            <div class="share-url-box">
                <input type="text" class="share-url-input" id="shareUrlInput" readonly>
                <button class="copy-btn" onclick="copyShareUrl()">ã‚³ãƒ”ãƒ¼</button>
            </div>
            <div class="share-buttons">
                <a href="#" class="share-btn line" id="lineShareBtn" target="_blank">
                    ğŸ“± LINE
                </a>
            </div>
            <button class="share-btn close" onclick="closeShareModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // ===== ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸé–¢é€£ =====
        let currentUserId = null;
        let syncTimer = null;
        let isSyncing = false;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ï¼ˆlocalStorageã‹ã‚‰ï¼‰
        function getSavedUserId() {
            return localStorage.getItem('travelMapUserId');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showUserModal() {
            document.getElementById('userModal').classList.remove('hidden');
            document.getElementById('userIdInput').value = currentUserId || '';
            document.getElementById('logoutBtn').style.display = currentUserId ? 'block' : 'none';
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
        }

        // ãƒ­ã‚°ã‚¤ãƒ³/æ–°è¦ä½œæˆ
        async function loginUser() {
            const userId = document.getElementById('userIdInput').value.trim().toLowerCase();
            if (!userId || userId.length < 3) {
                alert('IDã¯3æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿è¨±å¯
            if (!/^[a-z0-9_-]+$/.test(userId)) {
                alert('IDã¯è‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ä½¿ç”¨ã§ãã¾ã™');
                return;
            }

            currentUserId = userId;
            localStorage.setItem('travelMapUserId', userId);

            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            await loadFromCloud();

            updateSyncUI();
            closeUserModal();
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logoutUser() {
            currentUserId = null;
            localStorage.removeItem('travelMapUserId');
            updateSyncUI();
            closeUserModal();
        }

        // åŒæœŸUIã‚’æ›´æ–°
        function updateSyncUI() {
            const indicator = document.getElementById('syncIndicator');
            const displayId = document.getElementById('displayUserId');

            if (currentUserId) {
                displayId.textContent = currentUserId;
                indicator.className = 'sync-indicator';
            } else {
                displayId.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
                indicator.className = 'sync-indicator offline';
            }
        }

        // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadFromCloud() {
            if (!currentUserId) return;

            const indicator = document.getElementById('syncIndicator');
            indicator.className = 'sync-indicator syncing';

            try {
                const response = await fetch(`/api/sync/${currentUserId}`);
                const result = await response.json();

                if (result.success && result.data) {
                    // ã‚·ãƒ‰ãƒ‹ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿
                    if (result.data.sydney) {
                        localStorage.setItem('australiaTravelMap_sydney', JSON.stringify(result.data.sydney));
                    }
                    // ãƒ¡ãƒ«ãƒœãƒ«ãƒ³ã®ãƒ‡ãƒ¼ã‚¿
                    if (result.data.melbourne) {
                        localStorage.setItem('australiaTravelMap_melbourne', JSON.stringify(result.data.melbourne));
                    }

                    // ç¾åœ¨ã®éƒ½å¸‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    loadFromLocalStorage();
                    renderSpotList();
                    renderSavedSpots();
                    renderHiddenSpots();
                    updateMarkers();
                }

                indicator.className = 'sync-indicator';
            } catch (e) {
                console.error('Cloud load error:', e);
                indicator.className = 'sync-indicator offline';
            }
        }

        // ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        async function saveToCloud() {
            if (!currentUserId || isSyncing) return;

            isSyncing = true;
            const indicator = document.getElementById('syncIndicator');
            indicator.className = 'sync-indicator syncing';

            try {
                // ä¸¡éƒ½å¸‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const sydneyData = localStorage.getItem('australiaTravelMap_sydney');
                const melbourneData = localStorage.getItem('australiaTravelMap_melbourne');

                const data = {
                    sydney: sydneyData ? JSON.parse(sydneyData) : null,
                    melbourne: melbourneData ? JSON.parse(melbourneData) : null
                };

                await fetch(`/api/sync/${currentUserId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                indicator.className = 'sync-indicator';
            } catch (e) {
                console.error('Cloud save error:', e);
                indicator.className = 'sync-indicator offline';
            } finally {
                isSyncing = false;
            }
        }

        // ä¿å­˜æ™‚ã«è‡ªå‹•ã§ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚‚åŒæœŸï¼ˆdebounceä»˜ãï¼‰
        function scheduleSyncToCloud() {
            if (syncTimer) clearTimeout(syncTimer);
            syncTimer = setTimeout(() => {
                saveToCloud();
            }, 1000); // 1ç§’å¾Œã«åŒæœŸ
        }

        // ãƒšãƒ¼ã‚¸ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚ŒãŸæ™‚ã«å†åŒæœŸ
        document.addEventListener('visibilitychange', async function() {
            if (document.visibilityState === 'visible' && currentUserId) {
                await loadFromCloud();
            }
        });

        // æ‰‹å‹•ã§æœ€æ–°æƒ…å ±ã«æ›´æ–°
        async function refreshData() {
            // ç¢ºèªã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
            const confirmed = confirm('ç¾åœ¨ã®æƒ…å ±ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ');
            if (!confirmed) {
                return;
            }

            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'â³';

            if (currentUserId) {
                await loadFromCloud();
            } else {
                // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                location.reload();
                return;
            }

            refreshBtn.textContent = 'âœ…';
            setTimeout(() => {
                refreshBtn.textContent = 'ğŸ”„';
                refreshBtn.disabled = false;
            }, 1000);
        }

        // ã‚·ãƒ‰ãƒ‹ãƒ¼ã®ä¸»è¦è¦³å…‰åœ°ãƒ‡ãƒ¼ã‚¿
        const sydneySpots = [
            { id: 1, name: "ã‚ªãƒšãƒ©ãƒã‚¦ã‚¹", nameEn: "Sydney Opera House", category: "landmark", icon: "ğŸ­", lat: -33.8568, lng: 151.2153, description: "ä¸–ç•Œéºç”£ã®è±¡å¾´çš„å»ºç¯‰" },
            { id: 2, name: "ãƒãƒ¼ãƒãƒ¼ãƒ–ãƒªãƒƒã‚¸", nameEn: "Sydney Harbour Bridge", category: "landmark", icon: "ğŸŒ‰", lat: -33.8523, lng: 151.2108, description: "ã‚·ãƒ‰ãƒ‹ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³" },
            { id: 3, name: "ãƒœãƒ³ãƒ€ã‚¤ãƒ“ãƒ¼ãƒ", nameEn: "Bondi Beach", category: "nature", icon: "ğŸ–ï¸", lat: -33.8908, lng: 151.2743, description: "æœ‰åãªã‚µãƒ¼ãƒ•ãƒ“ãƒ¼ãƒ" },
            { id: 4, name: "ãƒ­ã‚¤ãƒ¤ãƒ«æ¤ç‰©åœ’", nameEn: "Royal Botanic Garden", category: "nature", icon: "ğŸŒ¿", lat: -33.8642, lng: 151.2166, description: "ç¾ã—ã„åº­åœ’" },
            { id: 5, name: "ã‚¿ãƒ­ãƒ³ã‚¬å‹•ç‰©åœ’", nameEn: "Taronga Zoo", category: "nature", icon: "ğŸ¦", lat: -33.8436, lng: 151.2411, description: "çµ¶æ™¯ã®å‹•ç‰©åœ’" },
            { id: 6, name: "ãƒ€ãƒ¼ãƒªãƒ³ã‚°ãƒãƒ¼ãƒãƒ¼", nameEn: "Darling Harbour", category: "landmark", icon: "âš“", lat: -33.8724, lng: 151.1995, description: "ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒªã‚¢" },
            { id: 7, name: "ã‚¶ãƒ»ãƒ­ãƒƒã‚¯ã‚¹", nameEn: "The Rocks", category: "culture", icon: "ğŸ›ï¸", lat: -33.8599, lng: 151.2090, description: "æ­´å²åœ°åŒº" },
            { id: 8, name: "ãƒ•ã‚£ãƒƒã‚·ãƒ¥ãƒãƒ¼ã‚±ãƒƒãƒˆ", nameEn: "Sydney Fish Market", category: "food", icon: "ğŸ¦", lat: -33.8710, lng: 151.1916, description: "æ–°é®®ãªã‚·ãƒ¼ãƒ•ãƒ¼ãƒ‰" },
            { id: 9, name: "ãƒãƒ£ã‚¤ãƒŠã‚¿ã‚¦ãƒ³", nameEn: "Chinatown", category: "food", icon: "ğŸ¥¡", lat: -33.8785, lng: 151.2044, description: "ã‚¢ã‚¸ã‚¢æ–™ç†ã®å®åº«" },
            { id: 10, name: "NSWç¾è¡“é¤¨", nameEn: "Art Gallery of NSW", category: "culture", icon: "ğŸ–¼ï¸", lat: -33.8688, lng: 151.2173, description: "ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢ã‚¢ãƒ¼ãƒˆ" },
            { id: 11, name: "ã‚·ãƒ‰ãƒ‹ãƒ¼ã‚¿ãƒ¯ãƒ¼", nameEn: "Sydney Tower Eye", category: "landmark", icon: "ğŸ—¼", lat: -33.8705, lng: 151.2089, description: "360åº¦ãƒ‘ãƒãƒ©ãƒãƒ“ãƒ¥ãƒ¼" },
            { id: 12, name: "ãƒãƒ³ãƒªãƒ¼ãƒ“ãƒ¼ãƒ", nameEn: "Manly Beach", category: "nature", icon: "ğŸŒŠ", lat: -33.7969, lng: 151.2879, description: "ãƒ•ã‚§ãƒªãƒ¼ã§è¡Œããƒ“ãƒ¼ãƒ" },
            { id: 13, name: "ãƒ«ãƒŠãƒ‘ãƒ¼ã‚¯", nameEn: "Luna Park", category: "culture", icon: "ğŸ¡", lat: -33.8474, lng: 151.2093, description: "ãƒ¬ãƒˆãƒ­ãªéŠåœ’åœ°" },
            { id: 14, name: "ã‚µãƒ¼ã‚­ãƒ¥ãƒ©ãƒ¼ã‚­ãƒ¼", nameEn: "Circular Quay", category: "landmark", icon: "ğŸš¢", lat: -33.8611, lng: 151.2107, description: "ãƒ•ã‚§ãƒªãƒ¼ã‚¿ãƒ¼ãƒŸãƒŠãƒ«" },
            { id: 15, name: "ãƒ–ãƒ«ãƒ¼ãƒã‚¦ãƒ³ãƒ†ãƒ³ã‚º", nameEn: "Blue Mountains", category: "nature", icon: "â›°ï¸", lat: -33.7182, lng: 150.3119, description: "ä¸–ç•Œéºç”£ã®å±±å²³åœ°å¸¯" }
        ];

        // ãƒ¡ãƒ«ãƒœãƒ«ãƒ³ã®ä¸»è¦è¦³å…‰åœ°ãƒ‡ãƒ¼ã‚¿
        const melbourneSpots = [
            { id: 101, name: "ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ã‚¨ã‚¢", nameEn: "Federation Square", category: "landmark", icon: "ğŸ›ï¸", lat: -37.8180, lng: 144.9691, description: "å¸‚ã®ä¸­å¿ƒåºƒå ´" },
            { id: 102, name: "ãƒ•ãƒªãƒ³ãƒ€ãƒ¼ã‚¹ã‚¹ãƒˆãƒªãƒ¼ãƒˆé§…", nameEn: "Flinders Street Station", category: "landmark", icon: "ğŸš‰", lat: -37.8183, lng: 144.9671, description: "è±¡å¾´çš„ãªé§…èˆ" },
            { id: 103, name: "ã‚¯ã‚¤ãƒ¼ãƒ³ãƒ“ã‚¯ãƒˆãƒªã‚¢ãƒãƒ¼ã‚±ãƒƒãƒˆ", nameEn: "Queen Victoria Market", category: "food", icon: "ğŸ›’", lat: -37.8076, lng: 144.9568, description: "å—åŠçƒæœ€å¤§ã®å¸‚å ´" },
            { id: 104, name: "ãƒ¡ãƒ«ãƒœãƒ«ãƒ³ç‹ç«‹æ¤ç‰©åœ’", nameEn: "Royal Botanic Gardens", category: "nature", icon: "ğŸŒ¿", lat: -37.8304, lng: 144.9796, description: "ç¾ã—ã„åº­åœ’" },
            { id: 105, name: "ã‚»ãƒ³ãƒˆã‚­ãƒ«ãƒ€ãƒ“ãƒ¼ãƒ", nameEn: "St Kilda Beach", category: "nature", icon: "ğŸ–ï¸", lat: -37.8679, lng: 144.9739, description: "ãƒšãƒ³ã‚®ãƒ³ã‚‚è¦‹ã‚‰ã‚Œã‚‹ãƒ“ãƒ¼ãƒ" },
            { id: 106, name: "ãƒ“ã‚¯ãƒˆãƒªã‚¢å·ç«‹å›³æ›¸é¤¨", nameEn: "State Library Victoria", category: "culture", icon: "ğŸ“š", lat: -37.8098, lng: 144.9652, description: "ç¾ã—ã„ãƒ‰ãƒ¼ãƒ å‹é–²è¦§å®¤" },
            { id: 107, name: "ãƒ¡ãƒ«ãƒœãƒ«ãƒ³åšç‰©é¤¨", nameEn: "Melbourne Museum", category: "culture", icon: "ğŸ›ï¸", lat: -37.8033, lng: 144.9717, description: "å—åŠçƒæœ€å¤§ã®åšç‰©é¤¨" },
            { id: 108, name: "ãƒ›ã‚¤ã‚¸ãƒ£ãƒ¼ãƒ¬ãƒ¼ãƒ³", nameEn: "Hosier Lane", category: "culture", icon: "ğŸ¨", lat: -37.8165, lng: 144.9690, description: "ã‚¹ãƒˆãƒªãƒ¼ãƒˆã‚¢ãƒ¼ãƒˆã®è–åœ°" },
            { id: 109, name: "ãƒ¦ãƒ¼ãƒ¬ã‚«ã‚¿ãƒ¯ãƒ¼", nameEn: "Eureka Tower", category: "landmark", icon: "ğŸ—¼", lat: -37.8215, lng: 144.9646, description: "88éšã®å±•æœ›å°" },
            { id: 110, name: "ãƒ¡ãƒ«ãƒœãƒ«ãƒ³å‹•ç‰©åœ’", nameEn: "Melbourne Zoo", category: "nature", icon: "ğŸ¦", lat: -37.7847, lng: 144.9516, description: "ä¸–ç•Œæœ€å¤ã®å‹•ç‰©åœ’ã®ä¸€ã¤" },
            { id: 111, name: "ãƒ–ãƒ©ã‚¤ãƒˆãƒ³ãƒ“ãƒ¼ãƒ", nameEn: "Brighton Beach", category: "nature", icon: "ğŸ ", lat: -37.9178, lng: 144.9873, description: "ã‚«ãƒ©ãƒ•ãƒ«ãªãƒ“ãƒ¼ãƒãƒã‚¦ã‚¹" },
            { id: 112, name: "ã‚°ãƒ¬ãƒ¼ãƒˆã‚ªãƒ¼ã‚·ãƒ£ãƒ³ãƒ­ãƒ¼ãƒ‰", nameEn: "Great Ocean Road", category: "nature", icon: "ğŸŒŠ", lat: -38.6629, lng: 143.1050, description: "12ä½¿å¾’å²©ã®çµ¶æ™¯" },
            { id: 113, name: "ã‚µã‚¦ã‚¹ãƒ¡ãƒ«ãƒœãƒ«ãƒ³ãƒãƒ¼ã‚±ãƒƒãƒˆ", nameEn: "South Melbourne Market", category: "food", icon: "ğŸ¥", lat: -37.8326, lng: 144.9565, description: "åœ°å…ƒã§äººæ°—ã®ãƒãƒ¼ã‚±ãƒƒãƒˆ" },
            { id: 114, name: "ãƒãƒ£ã‚¤ãƒŠã‚¿ã‚¦ãƒ³", nameEn: "Chinatown", category: "food", icon: "ğŸ¥¡", lat: -37.8118, lng: 144.9685, description: "ã‚¢ã‚¸ã‚¢æ–™ç†ã®å®åº«" },
            { id: 115, name: "ãƒ¡ãƒ«ãƒœãƒ«ãƒ³ã‚¯ãƒªã‚±ãƒƒãƒˆã‚°ãƒ©ã‚¦ãƒ³ãƒ‰", nameEn: "MCG", category: "culture", icon: "ğŸŸï¸", lat: -37.8200, lng: 144.9834, description: "ã‚¹ãƒãƒ¼ãƒ„ã®è–åœ°" }
        ];

        // éƒ½å¸‚è¨­å®š
        const cityConfig = {
            sydney: {
                name: 'ã‚·ãƒ‰ãƒ‹ãƒ¼',
                emoji: 'ğŸ¦˜',
                center: [-33.8688, 151.2093],
                spots: sydneySpots,
                color: '#0077b6'
            },
            melbourne: {
                name: 'ãƒ¡ãƒ«ãƒœãƒ«ãƒ³',
                emoji: 'ğŸ¨',
                center: [-37.8136, 144.9631],
                spots: melbourneSpots,
                color: '#7b2cbf'
            }
        };

        // çŠ¶æ…‹ç®¡ç†
        let currentCity = 'sydney';
        let map;
        let markers = {};
        let startLocation = null;
        let endLocation = null;
        let selectedSpots = new Set();
        let customSpots = [];
        let hiddenSpots = new Set(); // å‰Šé™¤ï¼ˆéè¡¨ç¤ºï¼‰ã«ã—ãŸè¦³å…‰åœ°ID
        let spotOrder = []; // è¦³å…‰åœ°ã®è¡¨ç¤ºé †åº
        let currentCategory = 'all';
        let routeMode = 'transit';
        let routeLine = null;
        let tempCustomLocation = null;
        let selectedSearchResult = null; // æ¤œç´¢ã§é¸æŠã—ãŸå ´æ‰€
        let draggedItem = null; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ 
        let selectedCustomCategory = null; // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒãƒƒãƒˆã®ã‚«ãƒ†ã‚´ãƒª

        // ã‚«ãƒ†ã‚´ãƒªã‚¢ã‚¤ã‚³ãƒ³ã®ãƒãƒƒãƒ”ãƒ³ã‚°
        const categoryIcons = {
            landmark: 'ğŸ›ï¸',
            nature: 'ğŸŒ¿',
            culture: 'ğŸ­',
            food: 'ğŸ½ï¸'
        };

        // ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ
        function selectCategory(category) {
            selectedCustomCategory = category;
            document.querySelectorAll('.category-option').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.category === category);
            });
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // ä¿å­˜ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’èª­ã¿è¾¼ã¿
            const savedUserId = getSavedUserId();
            if (savedUserId) {
                currentUserId = savedUserId;
                // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ
                await loadFromCloud();
            }
            updateSyncUI();

            const loadedFromUrl = loadFromUrl();
            initMap();
            // URLã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã å ´åˆã¯localStorageã‚’ã‚¹ã‚­ãƒƒãƒ—
            if (!loadedFromUrl) {
                loadFromLocalStorage();
            }
            renderSpotList();
            renderSavedSpots();
            renderHiddenSpots();
            updateMarkers();
            updateCityUI();
        });

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰èª­ã¿è¾¼ã¿
        function loadFromUrl() {
            const params = new URLSearchParams(window.location.search);

            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (!params.toString()) return false;

            // éƒ½å¸‚
            const city = params.get('city');
            if (city && cityConfig[city]) {
                currentCity = city;
            }

            // é¸æŠã•ã‚ŒãŸã‚¹ãƒãƒƒãƒˆ
            const spots = params.get('spots');
            if (spots) {
                spots.split(',').forEach(id => selectedSpots.add(parseInt(id)));
            }

            // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒãƒƒãƒˆ
            const custom = params.get('custom');
            if (custom) {
                try {
                    customSpots = JSON.parse(decodeURIComponent(custom));
                    customSpots.forEach(s => selectedSpots.add(s.id));
                } catch (e) {}
            }

            // éè¡¨ç¤ºã®è¦³å…‰åœ°
            const hidden = params.get('hidden');
            if (hidden) {
                hidden.split(',').forEach(id => hiddenSpots.add(parseInt(id)));
            }

            // ä¸¦ã¹æ›¿ãˆé †åº
            const order = params.get('order');
            if (order) {
                spotOrder = order.split(',').map(id => parseInt(id));
            }

            // å‡ºç™ºåœ°
            const start = params.get('start');
            if (start) {
                const [name, lat, lng] = start.split('|');
                startLocation = { name: decodeURIComponent(name), lat: parseFloat(lat), lng: parseFloat(lng) };
            }

            // ç›®çš„åœ°
            const end = params.get('end');
            if (end) {
                const [name, lat, lng] = end.split('|');
                endLocation = { name: decodeURIComponent(name), lat: parseFloat(lat), lng: parseFloat(lng) };
            }

            updateLocationDisplay();
            return true; // URLã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã 
        }

        // éƒ½å¸‚åˆ‡ã‚Šæ›¿ãˆ
        function switchCity(city) {
            if (currentCity === city) return;

            // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            saveToLocalStorage();

            // éƒ½å¸‚ã‚’åˆ‡ã‚Šæ›¿ãˆ
            currentCity = city;

            // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
            selectedSpots.clear();
            customSpots = [];
            hiddenSpots.clear();
            spotOrder = [];
            startLocation = null;
            endLocation = null;
            if (routeLine) {
                map.removeLayer(routeLine);
                routeLine = null;
            }

            // æ–°ã—ã„éƒ½å¸‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            loadFromLocalStorage();

            // UIæ›´æ–°
            updateCityUI();
            renderSpotList();
            renderSavedSpots();
            renderHiddenSpots();
            updateLocationDisplay();
            updateMarkers();

            // ãƒãƒƒãƒ—ã‚’ç§»å‹•
            const config = cityConfig[currentCity];
            map.setView(config.center, 13);
        }

        // éƒ½å¸‚UIã‚’æ›´æ–°
        function updateCityUI() {
            const config = cityConfig[currentCity];

            // ã‚¿ãƒ–
            document.querySelectorAll('.city-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.city-tab.${currentCity}`).classList.add('active');

            // ãƒ˜ãƒƒãƒ€ãƒ¼
            const header = document.getElementById('header');
            const headerTitle = document.getElementById('headerTitle');
            header.className = `header ${currentCity === 'melbourne' ? 'melbourne' : ''}`;
            headerTitle.textContent = `${config.emoji} ${config.name}è¦³å…‰ãƒãƒƒãƒ—`;

            // æ¤œç´¢ãƒœã‚¿ãƒ³
            const searchBtn = document.getElementById('searchRouteBtn');
            searchBtn.className = `route-search-btn ${currentCity === 'melbourne' ? 'melbourne' : ''}`;
        }

        // ãƒãƒƒãƒ—åˆæœŸåŒ–
        function initMap() {
            const config = cityConfig[currentCity];
            map = L.map('map').setView(config.center, 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            map.on('click', function(e) {
                if (document.getElementById('tab-custom').classList.contains('active')) {
                    tempCustomLocation = { lat: e.latlng.lat, lng: e.latlng.lng };
                    document.getElementById('selectedCoords').textContent =
                        `é¸æŠä½ç½®: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;

                    if (markers['temp']) {
                        map.removeLayer(markers['temp']);
                    }
                    markers['temp'] = L.marker([e.latlng.lat, e.latlng.lng], {
                        icon: createCustomIcon('ğŸ“', '#fbbf24')
                    }).addTo(map);
                }
            });
        }

        function createCustomIcon(emoji, color) {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div class="marker-pin" style="background: ${color}"><span>${emoji}</span></div>`,
                iconSize: [30, 40],
                iconAnchor: [15, 40],
                popupAnchor: [0, -40]
            });
        }

        function getCurrentSpots() {
            // éè¡¨ç¤ºã«ã—ãŸè¦³å…‰åœ°ã‚’é™¤å¤–ã—ã¦è¿”ã™
            return cityConfig[currentCity].spots.filter(s => !hiddenSpots.has(s.id));
        }

        // ä¸¦ã¹æ›¿ãˆã‚’é©ç”¨ã—ãŸå…¨ã‚¹ãƒãƒƒãƒˆãƒªã‚¹ãƒˆã‚’å–å¾—
        function getOrderedSpots() {
            const defaultSpots = getCurrentSpots();
            const allSpots = [...defaultSpots, ...customSpots];

            // spotOrderãŒç©ºã®å ´åˆã¯åˆæœŸåŒ–
            if (spotOrder.length === 0) {
                spotOrder = allSpots.map(s => s.id);
            }

            // æ–°ã—ã„ã‚¹ãƒãƒƒãƒˆãŒã‚ã‚Œã°æœ«å°¾ã«è¿½åŠ 
            allSpots.forEach(spot => {
                if (!spotOrder.includes(spot.id)) {
                    spotOrder.push(spot.id);
                }
            });

            // å‰Šé™¤ã•ã‚ŒãŸã‚¹ãƒãƒƒãƒˆã‚’orderã‹ã‚‰é™¤å¤–
            const existingIds = new Set(allSpots.map(s => s.id));
            spotOrder = spotOrder.filter(id => existingIds.has(id));

            // é †åºã«å¾“ã£ã¦ã‚½ãƒ¼ãƒˆ
            return allSpots.sort((a, b) => {
                return spotOrder.indexOf(a.id) - spotOrder.indexOf(b.id);
            });
        }

        function renderSpotList() {
            const container = document.getElementById('spotList');
            const orderedSpots = getOrderedSpots();
            const filteredSpots = currentCategory === 'all'
                ? orderedSpots
                : orderedSpots.filter(s => s.category === currentCategory || (currentCategory === 'custom' && s.category === 'custom'));

            container.innerHTML = filteredSpots.map(spot => `
                <div class="spot-item ${selectedSpots.has(spot.id) ? 'selected' : ''}"
                     draggable="true"
                     data-spot-id="${spot.id}"
                     ondragstart="handleDragStart(event, ${spot.id})"
                     ondragend="handleDragEnd(event)"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event, ${spot.id})"
                     onclick="toggleSpot(${spot.id})">
                    <span class="drag-handle" onclick="event.stopPropagation()">â‹®â‹®</span>
                    <input type="checkbox" class="spot-checkbox" ${selectedSpots.has(spot.id) ? 'checked' : ''}>
                    <span class="spot-icon">${spot.icon}</span>
                    <div class="spot-info">
                        <div class="spot-name">${spot.name}</div>
                        <div class="spot-category">${spot.description || spot.nameEn}</div>
                    </div>
                    <div class="spot-actions">
                        <button class="spot-action-btn start" onclick="event.stopPropagation(); setAsStart(${spot.id})" title="å‡ºç™ºåœ°ã«è¨­å®š">S</button>
                        <button class="spot-action-btn end" onclick="event.stopPropagation(); setAsEnd(${spot.id})" title="ç›®çš„åœ°ã«è¨­å®š">E</button>
                        <button class="spot-action-btn delete" onclick="event.stopPropagation(); deleteSpot(${spot.id}, ${spot.isCustom === true})" title="å‰Šé™¤">âœ•</button>
                    </div>
                </div>
            `).join('');
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—é–¢é€£ã®é–¢æ•°
        function handleDragStart(event, spotId) {
            draggedItem = spotId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', spotId);
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            document.querySelectorAll('.spot-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedItem = null;
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            const targetItem = event.target.closest('.spot-item');
            if (targetItem && !targetItem.classList.contains('dragging')) {
                // ä»–ã®drag-overã‚’å‰Šé™¤
                document.querySelectorAll('.spot-item').forEach(item => {
                    item.classList.remove('drag-over');
                });
                targetItem.classList.add('drag-over');
            }
        }

        function handleDragLeave(event) {
            const targetItem = event.target.closest('.spot-item');
            if (targetItem) {
                targetItem.classList.remove('drag-over');
            }
        }

        function handleDrop(event, targetSpotId) {
            event.preventDefault();
            const targetItem = event.target.closest('.spot-item');
            if (targetItem) {
                targetItem.classList.remove('drag-over');
            }

            if (draggedItem === null || draggedItem === targetSpotId) return;

            // é †åºã‚’æ›´æ–°
            const fromIndex = spotOrder.indexOf(draggedItem);
            const toIndex = spotOrder.indexOf(targetSpotId);

            if (fromIndex !== -1 && toIndex !== -1) {
                // å…ƒã®ä½ç½®ã‹ã‚‰å‰Šé™¤
                spotOrder.splice(fromIndex, 1);
                // æ–°ã—ã„ä½ç½®ã«æŒ¿å…¥
                spotOrder.splice(toIndex, 0, draggedItem);

                // ãƒªã‚¹ãƒˆã‚’å†æç”»
                renderSpotList();
                saveToLocalStorage();
            }
        }

        function toggleSpot(id) {
            if (selectedSpots.has(id)) {
                selectedSpots.delete(id);
            } else {
                selectedSpots.add(id);
            }
            renderSpotList();
            updateMarkers();
            saveToLocalStorage();
        }

        function deleteSpot(id, isCustom) {
            if (!confirm('ã“ã®åœ°ç‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            let deletedSpot;

            if (isCustom) {
                // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒãƒƒãƒˆã®å ´åˆã¯å®Œå…¨å‰Šé™¤
                deletedSpot = customSpots.find(s => s.id === id);
                customSpots = customSpots.filter(s => s.id !== id);
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¦³å…‰åœ°ã®å ´åˆã¯éè¡¨ç¤ºãƒªã‚¹ãƒˆã«è¿½åŠ 
                deletedSpot = cityConfig[currentCity].spots.find(s => s.id === id);
                hiddenSpots.add(id);
            }

            selectedSpots.delete(id);

            if (startLocation && deletedSpot && startLocation.lat === deletedSpot.lat && startLocation.lng === deletedSpot.lng) {
                startLocation = null;
            }
            if (endLocation && deletedSpot && endLocation.lat === deletedSpot.lat && endLocation.lng === deletedSpot.lng) {
                endLocation = null;
            }

            updateLocationDisplay();
            renderSpotList();
            renderSavedSpots();
            renderHiddenSpots();
            updateMarkers();
            saveToLocalStorage();
        }

        // éè¡¨ç¤ºã®è¦³å…‰åœ°ã‚’å¾©å…ƒ
        function restoreSpot(id) {
            hiddenSpots.delete(id);
            renderSpotList();
            renderHiddenSpots();
            saveToLocalStorage();
        }

        // éè¡¨ç¤ºã®è¦³å…‰åœ°ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        function renderHiddenSpots() {
            const container = document.getElementById('hiddenSpotsList');
            if (!container) return;

            const hiddenList = cityConfig[currentCity].spots.filter(s => hiddenSpots.has(s.id));

            if (hiddenList.length === 0) {
                container.innerHTML = '<p class="empty-message">å‰Šé™¤ã—ãŸè¦³å…‰åœ°ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            container.innerHTML = hiddenList.map(spot => `
                <div class="saved-spot-item">
                    <div class="saved-spot-info">
                        <span>${spot.icon}</span>
                        <span>${spot.name}</span>
                    </div>
                    <div class="saved-spot-actions">
                        <button class="restore-btn" onclick="restoreSpot(${spot.id})">å¾©å…ƒ</button>
                    </div>
                </div>
            `).join('');
        }

        function setAsStart(id) {
            const orderedSpots = getOrderedSpots();
            const spot = orderedSpots.find(s => s.id === id);
            if (spot) {
                startLocation = { name: spot.name, lat: spot.lat, lng: spot.lng };
                updateLocationDisplay();
                updateMarkers();
                saveToLocalStorage();
            }
        }

        function setAsEnd(id) {
            const orderedSpots = getOrderedSpots();
            const spot = orderedSpots.find(s => s.id === id);
            if (spot) {
                endLocation = { name: spot.name, lat: spot.lat, lng: spot.lng };
                updateLocationDisplay();
                updateMarkers();
                saveToLocalStorage();
            }
        }

        function updateLocationDisplay() {
            const startDisplay = document.getElementById('startDisplay');
            const endDisplay = document.getElementById('endDisplay');
            const searchBtn = document.getElementById('searchRouteBtn');

            if (startLocation) {
                startDisplay.textContent = startLocation.name;
                startDisplay.classList.add('has-value');
            } else {
                startDisplay.textContent = 'ã‚¿ãƒƒãƒ—ã§è¨­å®š';
                startDisplay.classList.remove('has-value');
            }

            if (endLocation) {
                endDisplay.textContent = endLocation.name;
                endDisplay.classList.add('has-value', 'end');
            } else {
                endDisplay.textContent = 'ã‚¿ãƒƒãƒ—ã§è¨­å®š';
                endDisplay.classList.remove('has-value', 'end');
            }

            searchBtn.disabled = !(startLocation && endLocation);
        }

        function clearLocation(type) {
            if (type === 'start') {
                startLocation = null;
            } else {
                endLocation = null;
            }
            updateLocationDisplay();
            updateMarkers();
            if (routeLine) {
                map.removeLayer(routeLine);
                routeLine = null;
            }
            document.getElementById('routeInfoPanel').classList.remove('visible');
            saveToLocalStorage();
        }

        function updateMarkers() {
            Object.keys(markers).forEach(key => {
                if (key !== 'temp') {
                    map.removeLayer(markers[key]);
                    delete markers[key];
                }
            });

            const allSpots = getOrderedSpots();
            const config = cityConfig[currentCity];

            selectedSpots.forEach(id => {
                const spot = allSpots.find(s => s.id === id);
                if (spot) {
                    let color = config.color;
                    let emoji = spot.icon;

                    if (startLocation && startLocation.lat === spot.lat && startLocation.lng === spot.lng) {
                        color = '#22c55e';
                        emoji = 'ğŸš©';
                    } else if (endLocation && endLocation.lat === spot.lat && endLocation.lng === spot.lng) {
                        color = '#ef4444';
                        emoji = 'ğŸ“';
                    }

                    markers[`spot-${id}`] = L.marker([spot.lat, spot.lng], {
                        icon: createCustomIcon(emoji, color)
                    }).addTo(map).bindPopup(`
                        <strong>${spot.name}</strong><br>
                        ${spot.nameEn || ''}<br>
                        <small>${spot.description || ''}</small>
                    `);
                }
            });

            if (startLocation && endLocation) {
                if (routeLine) {
                    map.removeLayer(routeLine);
                }
                routeLine = L.polyline([
                    [startLocation.lat, startLocation.lng],
                    [endLocation.lat, endLocation.lng]
                ], {
                    color: config.color,
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(map);

                const bounds = L.latLngBounds([
                    [startLocation.lat, startLocation.lng],
                    [endLocation.lat, endLocation.lng]
                ]);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function selectRouteMode(btn) {
            document.querySelectorAll('.route-option').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            routeMode = btn.dataset.mode;
        }

        function searchRoute() {
            if (!startLocation || !endLocation) return;

            // Google Mapsã‚’ç›´æ¥é–‹ã
            const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${startLocation.lat},${startLocation.lng}&destination=${endLocation.lat},${endLocation.lng}&travelmode=${routeMode}`;
            window.open(googleMapsUrl, '_blank');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`.tab-btn:nth-child(${tabName === 'spots' ? 1 : tabName === 'custom' ? 2 : 3})`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName !== 'custom' && markers['temp']) {
                map.removeLayer(markers['temp']);
                delete markers['temp'];
                tempCustomLocation = null;
                selectedSearchResult = null;
                document.getElementById('selectedCoords').textContent = '';
                document.getElementById('searchResults').innerHTML = '';
                document.getElementById('searchInput').value = '';
                document.getElementById('selectedLocationInfo').classList.remove('visible');
            }
        }

        function filterCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active',
                    (category === 'all' && btn.textContent === 'ã™ã¹ã¦') ||
                    btn.textContent.includes(getCategoryIcon(category))
                );
            });
            renderSpotList();
        }

        function getCategoryIcon(category) {
            const icons = { landmark: 'ğŸ›ï¸', nature: 'ğŸŒ¿', culture: 'ğŸ­', food: 'ğŸ½ï¸' };
            return icons[category] || '';
        }

        // ã‚«ã‚¿ã‚«ãƒŠâ†’è‹±èªå¤‰æ›è¾æ›¸ï¼ˆã‚ˆãä½¿ã‚ã‚Œã‚‹è¦³å…‰ãƒ»æ–½è¨­é–¢é€£ï¼‰
        const katakanaToEnglish = {
            'ãƒ›ãƒ†ãƒ«': 'Hotel', 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³': 'Restaurant', 'ã‚«ãƒ•ã‚§': 'Cafe',
            'ãƒ“ãƒ¼ãƒ': 'Beach', 'ãƒ‘ãƒ¼ã‚¯': 'Park', 'ãƒŸãƒ¥ãƒ¼ã‚¸ã‚¢ãƒ ': 'Museum',
            'ã‚®ãƒ£ãƒ©ãƒªãƒ¼': 'Gallery', 'ãƒãƒ¼ã‚±ãƒƒãƒˆ': 'Market', 'ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³': 'Station',
            'ã‚¿ãƒ¯ãƒ¼': 'Tower', 'ãƒ–ãƒªãƒƒã‚¸': 'Bridge', 'ãƒãƒ¼ãƒãƒ¼': 'Harbour',
            'ã‚¬ãƒ¼ãƒ‡ãƒ³': 'Garden', 'ã‚ºãƒ¼': 'Zoo', 'ã‚¢ã‚¯ã‚¢ãƒªã‚¦ãƒ ': 'Aquarium',
            'ã‚·ã‚¢ã‚¿ãƒ¼': 'Theatre', 'ã‚»ãƒ³ã‚¿ãƒ¼': 'Centre', 'ãƒ¢ãƒ¼ãƒ«': 'Mall',
            'ã‚¹ãƒˆãƒªãƒ¼ãƒˆ': 'Street', 'ãƒ­ãƒ¼ãƒ‰': 'Road', 'ã‚¢ãƒ™ãƒ‹ãƒ¥ãƒ¼': 'Avenue',
            'ãƒ—ãƒ¬ã‚¤ã‚¹': 'Place', 'ã‚¹ã‚¯ã‚¨ã‚¢': 'Square', 'ãƒã‚¤ãƒ³ãƒˆ': 'Point',
            'ãƒ™ã‚¤': 'Bay', 'ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰': 'Island', 'ãƒªãƒãƒ¼': 'River',
            'ã‚ªãƒšãƒ©ãƒã‚¦ã‚¹': 'Opera House', 'ãƒœã‚¿ãƒ‹ãƒƒã‚¯ã‚¬ãƒ¼ãƒ‡ãƒ³': 'Botanic Garden',
            'ãƒ•ã‚£ãƒƒã‚·ãƒ¥ãƒãƒ¼ã‚±ãƒƒãƒˆ': 'Fish Market', 'ãƒãƒ£ã‚¤ãƒŠã‚¿ã‚¦ãƒ³': 'Chinatown',
            'ãƒ€ãƒ¼ãƒªãƒ³ã‚°': 'Darling', 'ã‚µãƒ¼ã‚­ãƒ¥ãƒ©ãƒ¼': 'Circular', 'ã‚­ãƒ¼': 'Quay',
            'ãƒœãƒ³ãƒ€ã‚¤': 'Bondi', 'ãƒãƒ³ãƒªãƒ¼': 'Manly', 'ã‚¿ãƒ­ãƒ³ã‚¬': 'Taronga',
            'ãƒ­ãƒƒã‚¯ã‚¹': 'Rocks', 'ãƒ«ãƒŠ': 'Luna', 'ãƒ–ãƒ«ãƒ¼ãƒã‚¦ãƒ³ãƒ†ãƒ³': 'Blue Mountain',
            'ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³': 'Federation', 'ãƒ•ãƒªãƒ³ãƒ€ãƒ¼ã‚¹': 'Flinders',
            'ã‚¯ã‚¤ãƒ¼ãƒ³ãƒ“ã‚¯ãƒˆãƒªã‚¢': 'Queen Victoria', 'ã‚»ãƒ³ãƒˆã‚­ãƒ«ãƒ€': 'St Kilda',
            'ãƒ¤ãƒ©': 'Yarra', 'ãƒ¦ãƒ¼ãƒ¬ã‚«': 'Eureka', 'ã‚°ãƒ¬ãƒ¼ãƒˆã‚ªãƒ¼ã‚·ãƒ£ãƒ³': 'Great Ocean'
        };

        // æ—¥æœ¬èªã‚¯ã‚¨ãƒªã‚’è‹±èªã«å¤‰æ›
        function convertToEnglish(query) {
            let converted = query;
            for (const [ja, en] of Object.entries(katakanaToEnglish)) {
                // ã‚«ã‚¿ã‚«ãƒŠã®å‰å¾Œã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦å¤‰æ›ï¼ˆä¾‹ï¼šWãƒ›ãƒ†ãƒ« â†’ W Hotelï¼‰
                converted = converted.replace(new RegExp(ja, 'g'), ' ' + en + ' ');
            }
            // é€£ç¶šã™ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã‚’1ã¤ã«ã€å‰å¾Œã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤
            return converted.replace(/\s+/g, ' ').trim();
        }

        // å ´æ‰€ã‚’æ¤œç´¢
        async function searchLocation() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div class="searching-indicator">ğŸ” æ¤œç´¢ä¸­...</div>';

            // ç¾åœ¨ã®éƒ½å¸‚ã«åŸºã¥ã„ã¦æ¤œç´¢ç¯„å›²ã‚’è¨­å®š
            const config = cityConfig[currentCity];
            const cityNameEn = currentCity === 'sydney' ? 'Sydney' : 'Melbourne';
            const cityNameJa = currentCity === 'sydney' ? 'ã‚·ãƒ‰ãƒ‹ãƒ¼' : 'ãƒ¡ãƒ«ãƒœãƒ«ãƒ³';
            const viewbox = currentCity === 'sydney'
                ? '150.5,-34.2,151.5,-33.5' // ã‚·ãƒ‰ãƒ‹ãƒ¼å‘¨è¾º
                : '144.5,-38.2,145.5,-37.5'; // ãƒ¡ãƒ«ãƒœãƒ«ãƒ³å‘¨è¾º

            // æ—¥æœ¬èªãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹åˆ¤å®š
            const hasJapanese = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(query);

            // æ—¥æœ¬èªã‚’è‹±èªã«å¤‰æ›ã—ãŸã‚¯ã‚¨ãƒªã‚‚ä½œæˆ
            const englishQuery = convertToEnglish(query);

            try {
                let allResults = [];

                // æ¤œç´¢ã‚¯ã‚¨ãƒªã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
                const searchQueries = [];

                // è‹±èªå¤‰æ›ã—ãŸã‚¯ã‚¨ãƒªã‚’å„ªå…ˆ
                if (hasJapanese && englishQuery !== query) {
                    searchQueries.push(`${englishQuery} ${cityNameEn}`);
                }

                searchQueries.push(`${query} ${cityNameEn}`);

                // å„ã‚¯ã‚¨ãƒªã§æ¤œç´¢ã‚’è©¦è¡Œ
                for (const searchQuery of searchQueries) {
                    if (allResults.length >= 3) break;

                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?` +
                        `q=${encodeURIComponent(searchQuery)}&` +
                        `format=json&` +
                        `addressdetails=1&` +
                        `limit=5`
                    );
                    const results = await response.json();

                    // ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢å‘¨è¾ºã®çµæœã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆç·¯åº¦ãŒè² ã®å€¤ï¼å—åŠçƒï¼‰
                    const filteredResults = results.filter(r => {
                        const lat = parseFloat(r.lat);
                        return lat < 0;
                    });

                    allResults = allResults.concat(filteredResults);
                }

                // ã¾ã çµæœãŒãªã„å ´åˆã€ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢å…¨ä½“ã§æ¤œç´¢
                if (allResults.length === 0) {
                    const fallbackQuery = hasJapanese && englishQuery !== query ? englishQuery : query;
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?` +
                        `q=${encodeURIComponent(fallbackQuery)}&` +
                        `format=json&` +
                        `addressdetails=1&` +
                        `limit=10&` +
                        `countrycodes=au`,
                        {
                            headers: {
                                'Accept-Language': 'en,ja;q=0.9'
                            }
                        }
                    );
                    const results = await response.json();
                    // å¯¾è±¡éƒ½å¸‚å‘¨è¾ºã®çµæœã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
                    const centerLat = currentCity === 'sydney' ? -33.87 : -37.81;
                    const centerLng = currentCity === 'sydney' ? 151.21 : 144.96;
                    allResults = results.filter(r => {
                        const dist = Math.sqrt(Math.pow(r.lat - centerLat, 2) + Math.pow(r.lon - centerLng, 2));
                        return dist < 1.5; // ç´„150kmåœå†…
                    });
                }

                // é‡è¤‡ã‚’é™¤å»ï¼ˆåŒã˜ç·¯åº¦çµŒåº¦ã®çµæœï¼‰
                const uniqueResults = allResults.filter((result, index, self) =>
                    index === self.findIndex(r =>
                        Math.abs(r.lat - result.lat) < 0.0001 &&
                        Math.abs(r.lon - result.lon) < 0.0001
                    )
                ).slice(0, 5);

                if (uniqueResults.length === 0) {
                    resultsContainer.innerHTML = '<div class="no-results">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚</div>';
                    return;
                }

                const results = uniqueResults;

                resultsContainer.innerHTML = results.map((result, index) => {
                    const icon = getPlaceIcon(result.type, result.class);
                    // åå‰ã‚’å–å¾—ï¼ˆéŸ“å›½èªã‚„ä»–ã®è¨€èªã®å ´åˆã¯è‹±èªåã‚’å„ªå…ˆï¼‰
                    let name = result.name || result.display_name.split(',')[0];
                    // éŸ“å›½èªãƒ»ä¸­å›½èªãªã©ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€display_nameã‹ã‚‰è‹±èªéƒ¨åˆ†ã‚’æŠ½å‡º
                    if (/[\uAC00-\uD7AF\u4E00-\u9FFF]/.test(name) && !(/[\u3040-\u309F\u30A0-\u30FF]/.test(name))) {
                        // display_nameã‹ã‚‰æœ€åˆã®è‹±èªéƒ¨åˆ†ã‚’æ¢ã™
                        const englishMatch = result.display_name.match(/[A-Za-z][A-Za-z0-9\s\-'&]+/);
                        if (englishMatch) {
                            name = englishMatch[0].trim();
                        }
                    }
                    // ä½æ‰€ã‚‚æ•´å½¢ï¼ˆã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢ã®éƒ¨åˆ†ã‚’æŠ½å‡ºï¼‰
                    let address = result.display_name;
                    // ä½æ‰€ã‹ã‚‰éŸ“å›½èªãªã©ã‚’é™¤å»ã—ã€è‹±èªéƒ¨åˆ†ã®ã¿è¡¨ç¤º
                    if (/[\uAC00-\uD7AF]/.test(address)) {
                        const parts = address.split(',').filter(part => !/[\uAC00-\uD7AF]/.test(part));
                        address = parts.join(',').trim() || result.display_name;
                    }

                    return `
                        <div class="search-result-item" onclick="selectSearchResult(${index}, ${result.lat}, ${result.lon}, '${escapeHtml(name)}', '${escapeHtml(address)}')">
                            <span class="search-result-icon">${icon}</span>
                            <div class="search-result-info">
                                <div class="search-result-name">${name}</div>
                                <div class="search-result-address">${address}</div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = '<div class="no-results">æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚</div>';
            }
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        // å ´æ‰€ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
        function getPlaceIcon(type, placeClass) {
            const icons = {
                'hotel': 'ğŸ¨',
                'restaurant': 'ğŸ½ï¸',
                'cafe': 'â˜•',
                'bar': 'ğŸº',
                'museum': 'ğŸ›ï¸',
                'gallery': 'ğŸ–¼ï¸',
                'theatre': 'ğŸ­',
                'cinema': 'ğŸ¬',
                'park': 'ğŸŒ³',
                'beach': 'ğŸ–ï¸',
                'station': 'ğŸš‰',
                'airport': 'âœˆï¸',
                'hospital': 'ğŸ¥',
                'pharmacy': 'ğŸ’Š',
                'bank': 'ğŸ¦',
                'shop': 'ğŸ›’',
                'supermarket': 'ğŸ›’',
                'mall': 'ğŸ›ï¸',
                'attraction': 'â­',
                'viewpoint': 'ğŸ‘€'
            };
            return icons[type] || icons[placeClass] || 'ğŸ“';
        }

        // æ¤œç´¢çµæœã‚’é¸æŠ
        function selectSearchResult(index, lat, lng, name, address) {
            // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.search-result-item').forEach((item, i) => {
                item.classList.toggle('selected', i === index);
            });

            // ä½ç½®æƒ…å ±ã‚’ä¿å­˜
            tempCustomLocation = { lat: parseFloat(lat), lng: parseFloat(lng) };
            selectedSearchResult = { name, address };

            // ãƒãƒƒãƒ—ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
            if (markers['temp']) {
                map.removeLayer(markers['temp']);
            }
            markers['temp'] = L.marker([lat, lng], {
                icon: createCustomIcon('ğŸ“', '#fbbf24')
            }).addTo(map);

            // ãƒãƒƒãƒ—ã‚’ç§»å‹•
            map.setView([lat, lng], 16);

            // é¸æŠã—ãŸå ´æ‰€ã®æƒ…å ±ã‚’è¡¨ç¤º
            const infoContainer = document.getElementById('selectedLocationInfo');
            infoContainer.innerHTML = `
                <div class="name">âœ… ${name}</div>
                <div class="address">${address}</div>
            `;
            infoContainer.classList.add('visible');

            // åº§æ¨™ã‚‚è¡¨ç¤º
            document.getElementById('selectedCoords').textContent =
                `é¸æŠä½ç½®: ${parseFloat(lat).toFixed(4)}, ${parseFloat(lng).toFixed(4)}`;
        }

        // Enterã‚­ãƒ¼ã§æ¤œç´¢
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            searchLocation();
                        }
                    });
                }
            }, 100);
        });

        function addCustomSpot() {
            const customName = document.getElementById('customSpotName').value.trim();

            if (!tempCustomLocation) {
                alert('æ¤œç´¢çµæœã‚’é¸æŠã™ã‚‹ã‹ã€ãƒãƒƒãƒ—ä¸Šã§ä½ç½®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
                return;
            }

            // åå‰ã®æ±ºå®š: å…¥åŠ›ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°æ¤œç´¢çµæœã®åå‰ã‚’ä½¿ç”¨
            let name = customName;
            if (!name && selectedSearchResult) {
                name = selectedSearchResult.name;
            }
            if (!name) {
                alert('åœ°ç‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ã‚«ãƒ†ã‚´ãƒªã¨ã‚¢ã‚¤ã‚³ãƒ³ã®æ±ºå®š
            const category = selectedCustomCategory || 'landmark';
            const icon = categoryIcons[category] || 'ğŸ“Œ';

            const newSpot = {
                id: Date.now(),
                name: name,
                nameEn: selectedSearchResult ? selectedSearchResult.address : '',
                category: category,
                icon: icon,
                lat: tempCustomLocation.lat,
                lng: tempCustomLocation.lng,
                description: selectedSearchResult ? selectedSearchResult.address.split(',').slice(0, 2).join(', ') : 'ã‚«ã‚¹ã‚¿ãƒ è¿½åŠ ',
                isCustom: true // ã‚«ã‚¹ã‚¿ãƒ è¿½åŠ ãƒ•ãƒ©ã‚°
            };

            customSpots.push(newSpot);
            selectedSpots.add(newSpot.id);

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('customSpotName').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('selectedCoords').textContent = '';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('selectedLocationInfo').classList.remove('visible');
            document.getElementById('selectedLocationInfo').innerHTML = '';
            // ã‚«ãƒ†ã‚´ãƒªé¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            selectedCustomCategory = null;
            document.querySelectorAll('.category-option').forEach(btn => btn.classList.remove('selected'));

            tempCustomLocation = null;
            selectedSearchResult = null;

            if (markers['temp']) {
                map.removeLayer(markers['temp']);
                delete markers['temp'];
            }

            renderSpotList();
            renderSavedSpots();
            updateMarkers();
            saveToLocalStorage();

            alert(`ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`);
        }

        function renderSavedSpots() {
            const container = document.getElementById('savedSpotsList');
            if (customSpots.length === 0) {
                container.innerHTML = '<p class="empty-message">ä¿å­˜æ¸ˆã¿ã®åœ°ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            container.innerHTML = customSpots.map(spot => `
                <div class="saved-spot-item">
                    <div class="saved-spot-info">
                        <span>${spot.icon}</span>
                        <span>${spot.name}</span>
                    </div>
                    <div class="saved-spot-actions">
                        <button class="spot-action-btn start" onclick="setAsStart(${spot.id})" title="å‡ºç™ºåœ°ã«è¨­å®š">S</button>
                        <button class="spot-action-btn end" onclick="setAsEnd(${spot.id})" title="ç›®çš„åœ°ã«è¨­å®š">E</button>
                        <button class="delete-saved-btn" onclick="deleteSpot(${spot.id})">å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function getStorageKey() {
            return `australiaTravelMap_${currentCity}`;
        }

        function saveToLocalStorage() {
            const data = {
                selectedSpots: Array.from(selectedSpots),
                customSpots: customSpots,
                hiddenSpots: Array.from(hiddenSpots),
                spotOrder: spotOrder,
                startLocation: startLocation,
                endLocation: endLocation
            };
            localStorage.setItem(getStorageKey(), JSON.stringify(data));

            // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ãªã‚‰ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚‚åŒæœŸ
            if (currentUserId) {
                scheduleSyncToCloud();
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem(getStorageKey());
            if (saved) {
                const data = JSON.parse(saved);
                selectedSpots = new Set(data.selectedSpots || []);
                customSpots = data.customSpots || [];
                hiddenSpots = new Set(data.hiddenSpots || []);
                spotOrder = data.spotOrder || [];
                startLocation = data.startLocation || null;
                endLocation = data.endLocation || null;
                updateLocationDisplay();
            }
        }

        function clearAllData() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem(getStorageKey());
                selectedSpots.clear();
                customSpots = [];
                hiddenSpots.clear();
                spotOrder = [];
                startLocation = null;
                endLocation = null;
                if (routeLine) {
                    map.removeLayer(routeLine);
                    routeLine = null;
                }
                window.history.replaceState({}, '', window.location.pathname);
                updateLocationDisplay();
                renderSpotList();
                renderSavedSpots();
                renderHiddenSpots();
                updateMarkers();
            }
        }

        function generateShareUrl() {
            const params = new URLSearchParams();

            // éƒ½å¸‚
            params.set('city', currentCity);

            // é¸æŠã•ã‚ŒãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¦³å…‰åœ°
            const defaultSpots = getCurrentSpots();
            const defaultSpotIds = Array.from(selectedSpots).filter(id => defaultSpots.some(s => s.id === id));
            if (defaultSpotIds.length > 0) {
                params.set('spots', defaultSpotIds.join(','));
            }

            // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒãƒƒãƒˆ
            if (customSpots.length > 0) {
                params.set('custom', encodeURIComponent(JSON.stringify(customSpots)));
            }

            // éè¡¨ç¤ºã®è¦³å…‰åœ°
            if (hiddenSpots.size > 0) {
                params.set('hidden', Array.from(hiddenSpots).join(','));
            }

            // ä¸¦ã¹æ›¿ãˆé †åºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ç•°ãªã‚‹å ´åˆã®ã¿ï¼‰
            if (spotOrder.length > 0) {
                params.set('order', spotOrder.join(','));
            }

            // å‡ºç™ºåœ°
            if (startLocation) {
                params.set('start', `${encodeURIComponent(startLocation.name)}|${startLocation.lat}|${startLocation.lng}`);
            }

            // ç›®çš„åœ°
            if (endLocation) {
                params.set('end', `${encodeURIComponent(endLocation.name)}|${endLocation.lat}|${endLocation.lng}`);
            }

            const baseUrl = window.location.origin + window.location.pathname;
            return params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl;
        }

        function shareUrl() {
            const shareUrl = generateShareUrl();
            document.getElementById('shareUrlInput').value = shareUrl;

            const config = cityConfig[currentCity];
            const text = `${config.name}è¦³å…‰ãƒãƒƒãƒ—`;
            document.getElementById('lineShareBtn').href = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(text)}`;

            document.getElementById('shareOverlay').classList.add('visible');
        }

        function copyShareUrl() {
            const input = document.getElementById('shareUrlInput');
            input.select();
            document.execCommand('copy');
            alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        }

        function closeShareModal() {
            document.getElementById('shareOverlay').classList.remove('visible');
        }

        // åœ°å›³ã®æœ€å°åŒ–/å¾©å…ƒ
        let isMapMinimized = false;

        function toggleMap() {
            const mapContainer = document.getElementById('mapContainer');
            const restoreBar = document.getElementById('mapRestoreBar');
            const toggleBtn = document.getElementById('mapToggleBtn');

            isMapMinimized = !isMapMinimized;

            if (isMapMinimized) {
                mapContainer.classList.add('minimized');
                restoreBar.classList.add('visible');
            } else {
                mapContainer.classList.remove('minimized');
                restoreBar.classList.remove('visible');
                // åœ°å›³ã®ã‚µã‚¤ã‚ºã‚’å†è¨ˆç®—
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 350);
            }
        }
    </script>
</body>
</html>
